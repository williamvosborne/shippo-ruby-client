#!/usr/bin/env ruby 

lib = File.expand_path('../../lib', __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require 'bundler/setup'
require 'shippo'
require 'colored2'
require 'awesome_print'

# This example demonstrates how to purchase a label for a domestic US shipment.
# replace YOUR_PRIVATE_TOKEN with your ShippoToken key
Shippo::Api.token = 'YOUR_PRIVATE_TOKEN'

# Create address_from object
address_from      = {
  :object_purpose => 'PURCHASE',
  :name           => 'Mr Hippo',
  :company        => 'Shippo',
  :street1        => '215 Clayton St.',
  :street2        => '',
  :city           => 'San Francisco',
  :state          => 'CA',
  :zip            => '94117',
  :country        => 'US',
  :phone          => '+1 555 341 9393',
  :email          => 'support@goshippo.com' }

# Create address_to object
address_to        = {
  :object_purpose => 'PURCHASE',
  :name           => 'Mrs Hippo"',
  :company        => 'San Diego Zoo',
  :street1        => '2920 Zoo Drive',
  :city           => 'San Diego',
  :state          => 'CA',
  :zip            => '92101',
  :country        => 'US',
  :phone          => '+1 555 341 9393',
  :email          => 'hippo@goshippo.com' }

# Create parcel object
parcel            = {
  :length        => 5,
  :width         => 2,
  :height        => 5,
  :distance_unit => :in,
  :weight        => 2,
  :mass_unit     => :lb }

begin
  hash     = { :object_purpose => 'PURCHASE',
               :address_from   => address_from,
               :address_to     => address_to,
               :parcel         => parcel,
               :async          => false }
  puts 'Making the first API call with the following parameters:'.bold.green.underlined
  ap hash

  shipment = Shippo::Model::Shipment.create(hash)

# Get the desired rate according to your business logic
# We select the first rate in this example
  rate     = shipment.rates()[0]
  puts 'Rates generated:'.bold.green.underlined
  ap rate

  puts "Purchasing a #{rate.provider} #{rate.servicelevel_name} Label:".bold.green.underlined

# Purchase the desired rate (create a Transaction object)
  transaction = Shippo::Model::Transaction.create(
    :rate  => rate['object_id'],
    :async => false)

  if transaction.object_status == 'SUCCESS'
    puts 'OK'.bold.green
    puts "Label URL      : #{transaction.label_url.bold.yellow }"
    puts "Tracking NO    : #{transaction.tracking_number.to_s.bold.yellow}"
  else
    puts 'ERROR'.bold.red
    puts transaction.messages.bold.red
  end
rescue Exception => e
  puts 'ERROR:'.yellow.underlined + "\n"
  puts e.message.bold.red
  raise e
end


